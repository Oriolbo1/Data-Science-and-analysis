---
title: "Retail Store"
author: "Oriol Monjo"
date: "19/2/2020"
output: html_document
---

```{r}
library("readxl")
library("ggplot2")
data <- read_excel("Retail.xls")
head(data)
str(data)
```

In order to analyze the data that we can find in the Excel, I will use a top-down approach, starting with a general vision of the whole world and then highlightingand getting more specific details of the data. 

During this case of study, I will provide an explanation of the most important things I see in the different plots.


I will start taking a look at the profit that the business obtains from the different countries. In this plot, we can see that the company is present in almost every country of the world. Some of these countries are not profitable, for example Turkey and Nigeria and Africa and Latin America, seem to obtain mixed result.

Germany, France, United Kingdom, India and China  are profitable markets, however, the most important market for this business seems to be the USA.



```{r}
Profit=aggregate(x = data$Profit, by = list(data$Country), FUN = "sum")

Profit=Profit[order(Profit$x),]
head(Profit)#Countries with less profit
tail(Profit)#Countries with greater profit.

Profit2=rbind(head(Profit),tail(Profit))
Profit2$Group.1=factor(Profit2$Group.1,levels =Profit2$Group.1[order(Profit2$x)])

ggplot(Profit2)+
  geom_col(aes(Profit2$Group.1,Profit2$x,fill=Profit2$x>0),show.legend = FALSE)+
  coord_flip()+
  labs(x = "Country",y="Profit",title="Most positive income vs most negative income")
  
```


Considering the sales that this business has, we can confirm that the USA holds the largest number of sales and so, it is the most important market for this business.

Before focusing this study on the USA, I would like to understand better the shipping costs of the company, because considering that it is a global business this is one of the most important variables for its success.


```{r}
Sales=aggregate(x = data$Sales, by = list(data$Country), FUN = "sum")
Sales=Sales[order(Sales$x),]
tail(Sales)

Sales2=tail(Sales)
Sales2$Group.1=factor(Sales2$Group.1,levels =Sales2$Group.1[order(Sales2$x)])

ggplot(Sales2)+
  geom_col(aes(Sales2$Group.1,Sales2$x,fill=Sales2$Group.1),show.legend = FALSE)+
  coord_flip()+
  labs(x = "Country",y="Sales",title="Countries where the business sells more ")

```

We will start the analysis of this graphic by highlighting that this business has 3 classes of products, “Furniture”, “Office Supplies” and “Technology”.

If we plot the Sales in the X-axis and the shipping costs in the Y-axis and separate the products by category, we can find a very interesting information.

Obviously, the costs of shipping increase with the sales, just because if we sell more, we have to send more products, which generate more shipping costs.

The most important information that we can obtain from this plot is that, the variance that the “Furniture” and “Office Supplies” show on the X-axis is notoriously lower than the variance of the “Technology” products. It is important, because it let us know that on average, to ship “Furniture” and “Office Supplies” is more costly than shipping “Technology” products.

This leads me to think that the “Furniture” and “Office Supplies” products should be big and bulky and that, overthought in the “Technology” category there are also some products with high shipping costs, some products in this category are lighter.


```{r}
ggplot(data)+
  geom_point(aes(data$Sales,data$`Shipping Cost`,color=data$Category))+
  labs(x = "Shipping Costs",y="Sales", colour = "Category",title="Sales vs Shipping Costs")
  
```

We will continue taking a look at the different Sub-categories that this business has.

Thanks to this plot, we can confirm what I suspected in the previous graphic. On one had in the “Furniture” category, we can find Bookcases, Chairs and Tables and in the “Office Supplies” category, we can mainly see Art and Appliances, all these products are quite big and difficult to ship, as thus, costly. On the other hand, in the “Technology” category there is a range of products, from heavy ones, like machines, to light ones, like phones or accessories.

The most important thing to see in this graphic is that I plotted the categories in the X-axis and the Profit in the Y-axis and thanks to that we can see that this business obtains profits from a good part of the sells, but for almost half of the sells this company do it looses money. 

```{r}
ggplot(data)+
  geom_point(aes(data$Category,data$Profit,color=data$`Sub-Category`),shape=3)+
  labs(x = "Category",y="Profit", colour = "Sub-Category",title="Profits of the Sub-Categoies")

```

If we take a closer look to the products that produce the greatest negative profit, -2000 $ or less, we can find furniture like “tables” and “chairs” or Office supplies such as “Binders” and “Appliances”. However, the most important negative  profit, come from the technology category with products like Machines and Phones. Let’s see if it is profitable for this business to even sell them.



```{r}
data_redu=data[data$Profit<=-2000,]
ggplot(data_redu)+
  geom_point(aes(data_redu$Category,data_redu$Profit,color=data_redu$`Sub-Category`),shape=3)+
  labs(x = "Category",y="Profit", colour = "Sub-Category",title="Negative profit greater than -2000$")

```

As we can see, the sub-category “tables” is generating a huge negative profit and, at the same time, as we have seen before, since it’s a Furniture subcategory, its shipping costs are high. We should consider if it is possible to eliminate this sub-category satisfying the demand of this sub-category with a substitutive product.

Another conclusion that we can take out of this chart is that the product “Machines” seems to be profitable enough to justify the looses that we have
selling a certain “Machines” that have a huge negative profit. Maybe, instead of deleting this whole Sub-category, we can search for which “Machines” are making the business to lose profit and to think whether to keep them or delete them. 


```{r}
data_sub=aggregate(x = data$Profit, by = list(data$`Sub-Category`), FUN = "sum")


data_sub$Group.1=factor(data_sub$Group.1,levels =data_sub$Group.1[order(data_sub$x)])
ggplot(data_sub)+
  geom_col(aes(data_sub$Group.1,data_sub$x,fill=data_sub$x>0),show.legend = FALSE)+
  coord_flip()+
  labs(x = "Sub-Category",y="Profit")
  
```

Now, we will search for the machines that have a negative impact in the profit of this business

As we can see in the following dataframe, these non-profitable machines are: 
Cubify CubeX 3D Printer Triple Head Print,
Cubify CubeX 3D Printer Double Head Print,
Cubify CubeX 3D Printer Double Head Print,
Lexmark MX611dhe Monochrome Laser Printer.

Considering that out of these 4 machines, 3 are "Cubify CubeX 3D", we will continue our analysis, examining the profit that we obtain from this line of products. 

```{r}
data[data$`Sub-Category`=="Machines" & data$Profit<=-2000,18]

```

Now we will search how many products of this line the business has and their profit.

As we can see in the following dataframe, there are just 4 products of this line, 3 of them are non-profitable, and just one is, however, its margin is too low.

The business should seriously consider if is worth it to keep selling this line of products. 


```{r}
data[grepl("Cubify CubeX 3D", data$`Product Name`),c(18,22)]
```

If we check the information that we have of these products we find that all of them have been sold in the USA and that the only one that is profitable is from the west part of the USA. 


```{r}
data_Cubify=data.frame(data[grepl("Cubify CubeX 3D", data$`Product Name`),])
data_Cubify
```

We will continue this exercice, analyzing the variance that exist between the different parts of the USA.

As we can see in the following boxplot, even though the median of profit in the West part of the USA is higher than the median in other parts, it is not a relevant difference. 

```{r}
data_USA=data[data$Market=="US",]
ggplot()+
  geom_boxplot(aes(data_USA$Region,data_USA$Profit),outlier.shape=NA)+
  coord_cartesian(ylim=c(-50,100))+
labs(x = "Region",y="Profit", title="Boxplot of the profit for every region of the USA")

```

One of the most interesting things that we can see with this USA sub-dataset that I created is that the “Ordering priority” that this business uses in this territory, are mainly "Medium" and "High".

It is especially important if we consider the big proportion of "High" and "Medium" Order priorities that are used for the East and West parts of the country. 


```{r}
ggplot()+
  geom_bar(aes(data_USA$`Order Priority`,fill=data_USA$Region))+
  labs(x = "Priority of the order",y="Frequency", fill = "Region",title="Frequency of Order Priorities by region")
  
```

Now I will analyze how the "Order Priority" is affected by the "Category" of the sent products.

In the following table, we will see how the percentage of the different “order priorities” is distributed between the different categories of products. 

For example, it is possible to see that the 20% of the “Critical order priorities” that the business sends are used for “Furniture” products, 60% for “Office Supplies” and 19% for “Technology”.

It is interesting to notice that in every case, the 60% of every Order priority is used to send Office supplies.

In order to understand better this data, we will use a barplot to see if this percentage can be explained by the quantity of Office supplies products.


```{r}
prop.table(table(data_USA$`Order Priority`,data_USA$Category),margin=2)
```

As we suspected, the Office supplies are the most sold category in the USA and, as the following plot shows, almost half of the Office Supplies aim the Consumer Market.


```{r}
ggplot(data_USA)+
  geom_bar(aes(data_USA$Category,fill=data_USA$`Order Priority`))+
  facet_wrap(~Segment)+
  labs(x = "Categories",y="Frequency", fill = "Order Priority",title="Frequency of the categories by Order priority")

```

Now I will createa sub-database of the consumer merket of the USA. I will study this dataset with a greater focus on the numeric information that we can obtain from it.


```{r}
USA_consumer=data_USA[data_USA$Segment=="Consumer",]

```


I will start analyzing the existing correlations between this numeric data.

The first thing I notice is that the "Sales" and the "shipping Cost" have a clear correlation.

That makes a lot of sense, since, as we said before, the more this business sells, the more cost of shipping it will have. 

I assume that there is not a direct correlation because the costs of shipping vary depending on the product and category. 

At the same time, the Sales and the profit, have weak correlation because, as we have seen before, even though a lot of products are so profitable, this business also sells assets that are not profitable at all. 


```{r}
library(GGally)
ggpairs(USA_consumer[,19:23])
```

This next plot, confirms that there is a relation between the Sales and the Shipping Costs. 

However, it is possible to see that the different “Order Priorities” conform very distinct groups. The “Critical Priority” (the orange one), has a cost that grows in a very pronounced way and at the same time the “Medium Priority” (the purple one), can ship the products for a more affordable price.

This clear differences between groups of data, makes me think that if we divide this data in the different "Order Priority" groups, their correlations with the Sales will be much more clear.


```{r}
ggplot(USA_consumer)+
  geom_point(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales,color=USA_consumer$`Order Priority`))+
  geom_smooth(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales))+
  labs(x = "Shipping Costs",y="Sales", colour = "Order Priority",title="Sales vs Shipping Costs")
```

As we can see diving the data in this groups, we can predict much better the relation between the costs of shipping and the Sales. 


```{r}
ggplot(USA_consumer)+
  geom_point(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales,color=USA_consumer$`Order Priority`))+
  geom_smooth(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales))+
  facet_wrap(~`Order Priority`)+
  labs(x = "Shipping Costs",y="Sales", colour = "Order Priority",title="Sales vs Shipping Costs")

```

I will finish this analysis with a simple regression

My objective with this regression is to develop a simple and general predictor of the profit of the business in the consumer market of the USA just with the numeric data, no to build a perfect model, because to do it, would require more data, a deeper data analysis of the data and the transformation of the categorical information.


```{r}
reg=lm(USA_consumer$Profit~USA_consumer$Sales+USA_consumer$Quantity+USA_consumer$Discount+USA_consumer$`Shipping Cost`-1)
summary(reg)
```

As we can see in the summary, just with the numeric data, we can explain the 32% of the Profit of the business in the Consumer market of the USA, using the variables Sales,Quantity,Discount and Shipping Cost.

Acording to our summary, all the data that we have used in this model is useful to explain the profit, however, the residuals of the model seem not to be normally distributed. 

If we watch carefully the residuals, we can see that seem that the data does not evolve in a random way, according to this plot the higher the numbers of "Sales","Quantity","Discount" and "Shipping Cost" are, the less accurate the model is. 

As I suspected, the model does not follow a normal distribution, according to this plot, this model in particular is especially bad with extreme numbers. 

After analyzing the model that I have built, I would recommend to complement it with the categorical data to improve it before predicting the expected profit.


```{r}
plot(reg)
```
