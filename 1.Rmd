This document is the second part of the analysis that we have started in the documment"1-Tableau".


```{r}
library("readxl")
library("ggplot2")
data <- read_excel("Retail.xls")

```

We will start by searching for the machines that have a negative impact in the profit of this business, -2000$ or less.

```{r}
data[data$`Sub-Category`=="Machines" & data$Profit<=-2000,18]

```

As we can see, these non-profitable machines are: 
  "Cubify CubeX 3D Printer Triple Head Print",
  "Cubify CubeX 3D Printer Double Head Print",
  "Cubify CubeX 3D Printer Double Head Print",
   and "Lexmark MX611dhe Monochrome Laser Printer".

Considering that out of these 4 machines, 3 are "Cubify CubeX 3D", I will continue my analysis, examining the profit that we obtain from this line of products. 


```{r}
data[grepl("Cubify CubeX 3D", data$`Product Name`),c(18,22)]

```

As we can see, there are just 4 products of this line, 3 of them are non-profitable, and just one is; however, it has a low margin.

The business should seriously consider if it worth it to keep selling this line of products. 

If we check the information that we have of these products we find that all of them have been sold in the USA and that the only one that is profitable is from the west part of this country.


```{r}
data_Cubify=data.frame(data[grepl("Cubify CubeX 3D", data$`Product Name`),])
data_Cubify
```

We will continue this exercice, analyzing the variance that exist between the different parts of the USA. For this purpose I will create a sub-dataset specific for the USA.

As we can see, even though the median of profit in the west part of the USA is higher than the median in other parts, it is not a relevant difference. 


```{r}
data_USA=data[data$Market=="US",]
ggplot()+
  geom_boxplot(aes(data_USA$Region,data_USA$Profit),outlier.shape=NA)+
  coord_cartesian(ylim=c(-50,100))


```

One of the most interesting things that we can see with this USA sub-dataset that I created is that the “Ordering priority” that this business uses in this territory, are mainly "Medium" and "High".

It is especially important if we consider the big proportion of "High" and "Medium" Order priorities that are used for the East and West parts of the country. 



```{r}
ggplot()+
  geom_bar(aes(data_USA$`Order Priority`,fill=data_USA$Region))
  
```


In the following table, we will see how the percentage of the different “Order priorities” is distributed between the different categories of products. 

For example, it is possible to see that the 20% of the “Critical order priorities” that the business sends are used for “Furniture” products, 60% for “Office Supplies” and 19% for “Technology”.

It is interesting to notice that in every case, the 60% of every Order priority is used to send Office supplies.

```{r}
prop.table(table(data_USA$`Order Priority`,data_USA$Category),margin=1)

```


In order to understand better this data, we will use a barplot to see if this percentage can be explained by the quantity of Office supplies products.

As we suspected, the Office supplies are the most sold category in the USA and, as the following plot shows, almost half of the Office Supplies aim the Consumer Market.


```{r}
ggplot(data_USA)+
  geom_bar(aes(data_USA$Category,fill=data_USA$`Order Priority`))+
  facet_wrap(~Segment)
```
#Numeric analysis

Now I will focus on the numeric information that we can obtain from the consumer market.

I will start analyzing the existing correlations between this numeric data.

The first thing I notice in the next plot is that the "Sales" and the "shipping Cost" have a clear correlation. This makes a lot of sense, since, as we said before, the more this business sells, the more cost of shipping it will have. 

I assume that there is not a direct correlation because the costs of shipping vary depending on the product and category. 

At the same time, the Sales and the profit, have weak correlation because, as we have seen before, even though a lot of products are so profitable, this business also sells assets that are not profitable at all. 


```{r}
USA_consumer=data_USA[data_USA$Segment=="Consumer",]
library(GGally)
ggpairs(USA_consumer[,19:23])
```


This next plot, confirms that there is a relation between the Sales and the Shipping Costs. 
However, it is possible to see that the different “Order Priorities” conform very distinct groups.

The “Critical Priority” (the orange one), has a cost that grows in a very pronounced way and at the same time the “Medium Priority” (the purple one), can ship the products for a more affordable price.

This clear differences between groups of data, makes me think that if we divide this data in the different "Order Priority" groups, their correlations with the Sales will be much more clear.


```{r}
ggplot(USA_consumer)+
  geom_point(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales,color=USA_consumer$`Order Priority`))+
  geom_smooth(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales))

```

As we can see dividing the data in this groups, we can predict much better the relation between the costs of shipping and the Sales. 


```{r}
ggplot(USA_consumer)+
  geom_point(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales,color=USA_consumer$`Order Priority`))+
  geom_smooth(aes(USA_consumer$`Shipping Cost`,USA_consumer$Sales))+
  facet_wrap(~`Order Priority`)


```

I will finish this analysis with a simple regression.

My objective with this regression is to develop a simple and general predictor of the profit of the business in the consumer market of the USA just with the numeric data. 

I am not trying to to build a perfect model, because in order to do that, I need to do a deeper data analysis, to transformation the categorical information and more data.


```{r}
reg=lm(USA_consumer$Profit~USA_consumer$Sales+USA_consumer$Quantity+USA_consumer$Discount+USA_consumer$`Shipping Cost`-1)
summary(reg)
```

As we can see in the summary, just with the numeric data, we can explain the 32% of the profit of the business in the Consumer market of the USA, using the following variables:
  Sales,
  Quantity,
  Discount,
  Shipping Cost.

All the data that we have used in this model is useful to explain the Profit, however, the residuals of the model seem not to be normally distributed. 

```{r}
plot(reg)
```

If we watch carefully the residuals, we can see that seem that the data does not evolve in a random way, according to this plot the higher the numbers of "Sales","Quantity","Discount" and "Shipping Cost" are, the less accurate the model is. 

As I suspected, the model does not follow a normal distribution, according to this plot, this model in particular is especially bad with extreme numbers.

After analyzing the model that I have built, I would recommend to complement it with the categorical data to improve it before predicting the expected profit.
